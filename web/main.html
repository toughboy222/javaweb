<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>ç¨€åœŸæ˜é‡‘</title>
  <link rel="stylesheet" href="main.css" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ä¸º Markdown æ‘˜è¦é¢„è§ˆæ·»åŠ æ ·å¼ (ä¿æŒè¿™éƒ¨åˆ†ä¸å˜) */
    .article-summary-markdown-preview {
      max-height: 3.6em;
      overflow: hidden;
      position: relative;
      line-height: 1.8em;
      margin-top: 8px;
      margin-bottom: 8px;
    }
    .article-summary-markdown-preview::after {
      content: "...";
      position: absolute;
      bottom: 0;
      right: 0;
      padding-left: 25px;
      background: linear-gradient(to right, transparent, white 70%, white);
      font-weight: bold;
      color: #555;
    }
    .article-summary-markdown-preview p {
      margin-top: 0;
      margin-bottom: 0.3em;
    }
    .article-summary-markdown-preview h1,
    .article-summary-markdown-preview h2,
    .article-summary-markdown-preview h3,
    .article-summary-markdown-preview h4,
    .article-summary-markdown-preview h5,
    .article-summary-markdown-preview h6 {
      font-size: 1.05em;
      margin-top: 0;
      margin-bottom: 0.2em;
      line-height: 1.4em;
    }
    .article-summary-markdown-preview ul,
    .article-summary-markdown-preview ol,
    .article-summary-markdown-preview blockquote,
    .article-summary-markdown-preview pre {
      margin: 0.2em 0;
      font-size: 0.9em;
      padding: 0;
    }
    .article-summary-markdown-preview ul,
    .article-summary-markdown-preview ol {
      margin-left: 1.5em;
    }
    .article-summary-markdown-preview pre {
      background-color: #f0f0f0;
      padding: 2px 4px;
    }
    .article-summary-markdown-preview code {
      font-size: 0.9em;
      background-color: #f0f0f0;
      padding: 1px 3px;
      border-radius: 2px;
    }
    .article-summary-markdown-preview pre code {
      background-color: transparent;
      padding: 0;
    }
    .article-summary-markdown-preview img {
      display: none;
    }
    /* --- ç»“æŸ Markdown æ‘˜è¦é¢„è§ˆæ ·å¼ --- */

    .article-meta .article-likes {
    }
    .rank-list li {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 8px 0;
    }
    .rank-list li a {
      text-decoration: none;
      color: #337ab7;
    }
    .rank-list li a:hover {
      text-decoration: underline;
      color: #23527c;
    }
    .rank-list li strong {
      margin-right: 8px;
      color: #e47417;
      min-width: 20px;
      display: inline-block;
    }
    .rank-list li .like-count-badge {
      float: right;
      color: #777;
      font-size: 0.9em;
      background-color: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      margin-left: 5px;
    }
    .rank-list li .author-name-rank {
      color: #333;
    }
    .user-area .nav-avatar { /* å¯¼èˆªæ å¤´åƒæ ·å¼ */
      width: 30px;
      height: 30px;
      border-radius: 50%;
      margin-right: 8px;
      object-fit: cover;
      vertical-align: middle;
    }
  </style>
</head>
<body>
<nav class="main-nav">
  <div class="nav-container">
    <div class="nav-left">
      <a class="logo" href="main.html">æ˜é‡‘</a>
      <div class="nav-menu">
        <a href="main.html" class="active" data-category-type="top" data-category-name="é¦–é¡µ">é¦–é¡µ</a>
        <a href="#" data-category-type="top" data-category-name="AI Coding">AI Coding</a>
        <a href="publish.html">å‘å¸ƒæ–‡ç« </a>
        <a href="my_articles.html">æˆ‘çš„æ–‡ç« </a>
        <a href="profile.html" id="navProfileLink" style="display:none;">ä¸ªäººèµ„æ–™</a>
        <a href="#" data-category-type="top" data-category-name="APP">APP</a>
        <a href="#" data-category-type="top" data-category-name="æ’ä»¶">æ’ä»¶</a>
      </div>
    </div>
    <div class="nav-right">
      <div class="search-box">
        <input type="text" placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹" />
        <button class="search-btn">ğŸ”</button>
      </div>
      <div class="user-area" style="display: flex; align-items: center;">
        <img id="navUserAvatar" src="default-avatar.png" alt="avatar" class="nav-avatar" style="display:none;">
        <a href="#" id="navUserNickname" class="vip-link" style="text-decoration:none; color:#007aff;">æ¬¢è¿ç™»å½•ï¼ï¼ï¼</a>
        <button id="logoutButton" style="display:none; margin-left: 10px; padding: 5px 10px; cursor:pointer;">ç™»å‡º</button>
      </div>
    </div>
  </div>
</nav>

<main class="content-container">
  <aside class="left-sidebar">
    <nav class="category-nav">
      <a href="#" class="active" data-category-type="side" data-category-name="ç»¼åˆ">ç»¼åˆ</a>
      <a href="#" data-category-type="side" data-category-name="åç«¯">åç«¯</a>
      <a href="#" data-category-type="side" data-category-name="å‰ç«¯">å‰ç«¯</a>
      <a href="#" data-category-type="side" data-category-name="Android">Android</a>
      <a href="#" data-category-type="side" data-category-name="iOS">iOS</a>
      <a href="#" data-category-type="side" data-category-name="äººå·¥æ™ºèƒ½">äººå·¥æ™ºèƒ½</a>
      <a href="#" data-category-type="side" data-category-name="å¼€å‘å·¥å…·">å¼€å‘å·¥å…·</a>
      <a href="#" data-category-type="side" data-category-name="ä»£ç äººç”Ÿ">ä»£ç äººç”Ÿ</a>
      <a href="#" data-category-type="side" data-category-name="é˜…è¯»">é˜…è¯»</a>
      <a href="#" data-category-type="side" data-category-name="å²ç¨‹æ˜Šä½œå“">220162401030å²ç¨‹æ˜Š</a>
    </nav>
  </aside>

  <div class="main-content" id="main-content">
    <p style="text-align:center; padding: 20px; color: #777;">æ­£åœ¨åŠ è½½å†…å®¹...</p>
  </div>

  <aside class="sidebar">
    <section class="user-status">
      <h3>ä½ å¥½ï¼</h3>
      <button class="sign-btn">å»ç­¾åˆ°</button>
      <p class="subtitle">ç‚¹äº®åœ¨ç¤¾åŒºçš„æ¯ä¸€å¤©</p>
    </section>
    <section class="authors">
      <h3>ä½œè€…æ¦œ</h3>
      <ul class="rank-list" id="author-rank-list">
        <li>æ­£åœ¨åŠ è½½ä½œè€…æ¦œ...</li>
      </ul>
    </section>
    <section class="ranking" id="hot-articles-section">
      <h3>çƒ­é—¨æ–‡ç« æ¦œ</h3>
      <ul class="rank-list" id="hot-article-rank-list">
        <li>æ­£åœ¨åŠ è½½çƒ­é—¨æ–‡ç« ...</li>
      </ul>
    </section>
  </aside>
</main>

<script>
  //const appBaseUrl = "http://localhost:8080/javaweb_Web_exploded";
  const contentArea = document.getElementById('main-content');
  const navLinks = document.querySelectorAll('.category-nav a');
  const topLinks = document.querySelectorAll('.nav-menu a');
  const staticTopContentMap = {
    "AI Coding": `<h2>AI Coding</h2><p>æ¢ç´¢AIè¾…åŠ©ç¼–ç¨‹çš„æœ€æ–°å·¥å…·å’Œå®è·µã€‚</p><p>è¿™é‡Œçš„å†…å®¹æ˜¯é™æ€å®šä¹‰çš„ã€‚</p>`,
    "APP": `<h2>APPä¸‹è½½</h2><p>æ‰«æäºŒç»´ç ä¸‹è½½æˆ‘ä»¬çš„APPã€‚</p>`,
    "æ’ä»¶": `<h2>æµè§ˆå™¨æ’ä»¶</h2><p>å®‰è£…æ˜é‡‘æµè§ˆå™¨æ’ä»¶ï¼Œæå‡é˜…è¯»ä½“éªŒã€‚</p>`
  };

  function escapeHtml(unsafe) {
    if (unsafe === null || typeof unsafe === 'undefined') return '';
    return unsafe.toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
  }

  function displayArticles(articles, displayArea, titlePrefix = "æ–‡ç« åˆ—è¡¨") {
    if (!Array.isArray(articles)) {
      console.error("displayArticles: ä¼ å…¥çš„ articles ä¸æ˜¯ä¸€ä¸ªæ•°ç»„", articles);
      displayArea.innerHTML = `<p class="error-message">åŠ è½½æ–‡ç« æ—¶å‘ç”Ÿé”™è¯¯ï¼Œæ•°æ®æ ¼å¼ä¸æ­£ç¡®ã€‚</p>`;
      return;
    }
    if (articles.length > 0) {
      let articlesHtml = `<h2 style="margin-bottom: 20px;">${escapeHtml(titlePrefix)}</h2>`;
      articles.forEach(article => {
        const markdownSnippet = article.contentSnippet || "";
        const renderedHtmlSnippet = marked.parse(markdownSnippet);

        let authorAvatarHtml = '';
        if (article.authorAvatarUrl) {
          // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨å¤„ç†
          authorAvatarHtml = `<img src="${article.authorAvatarUrl}" alt="author" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right:5px;">`;
        }
        // ç§»é™¤äº† authorAvatarHtml çš„å®šä¹‰å’Œä½¿ç”¨
        // let authorAvatarHtml = `<img src="default-avatar.png" alt="author" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right:5px;">`;
        // if (article.authorAvatarUrl && article.authorAvatarUrl !== 'default-avatar.png') {
        //   authorAvatarHtml = `<img src="${appBaseUrl}/${article.authorAvatarUrl}" alt="author" style="width:20px; height:20px; border-radius:50%; vertical-align:middle; margin-right:5px;">`;
        // }

        articlesHtml += `
          <div class="article">
            <h3 class="article-title"><a href="article.html?id=${article.id}">${escapeHtml(article.title)}</a></h3>
            <p class="article-meta">
              ä½œè€…: ${article.authorIdentifier ? escapeHtml(article.authorIdentifier) : 'åŒ¿å'} |
              åˆ†ç±»: ${article.category ? escapeHtml(article.category) : 'æ— '} |
              å‘å¸ƒäº: ${article.publishDate ? escapeHtml(article.publishDate) : 'æœªçŸ¥'} |
              <span class="article-likes">èµ: ${article.likesCount !== undefined ? article.likesCount : 0}</span>
            </p>
            <div class="article-summary-markdown-preview">
              ${renderedHtmlSnippet}
            </div>
            <a href="article.html?id=${article.id}" class="read-more" data-article-id="${article.id}">é˜…è¯»æ›´å¤š</a>
          </div>
        `;
      });
      displayArea.innerHTML = articlesHtml;
    } else {
      displayArea.innerHTML = `<p style="text-align:center; padding: 20px; color: #777;">è¯¥åˆ†ç±»ä¸‹æš‚æ— æ–‡ç« ï¼Œæˆ–æœªæ‰¾åˆ°ç›¸å…³æ–‡ç« ã€‚</p>`;
    }
  }

  function fetchAndDisplayArticles(categoryName, displayArea, titlePrefix) {
    displayArea.innerHTML = '<p style="text-align:center; padding: 20px; color: #777;">æ­£åœ¨åŠ è½½æ–‡ç« ...</p>';
    fetch(`GetArticlesByCategoryServlet?category=${encodeURIComponent(categoryName)}`)
            .then(response => {
              if (!response.ok) {
                return response.json().then(errData => {
                  throw new Error((errData && errData.error) ? errData.error : `è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç ï¼š${response.status}`);
                }).catch(() => {
                  throw new Error(`è¯·æ±‚æ–‡ç« åˆ—è¡¨å¤±è´¥ï¼ŒæœåŠ¡å™¨è¿”å›çŠ¶æ€ï¼š${response.status}`);
                });
              }
              return response.json();
            })
            .then(articles => {
              if (articles && articles.error) {
                displayArea.innerHTML = `<p class="error-message">åŠ è½½æ–‡ç« é”™è¯¯: ${escapeHtml(articles.error)}</p>`;
              } else {
                // ç¡®ä¿ ArticleDTO ä»ç„¶ä¼ é€’äº† authorAvatarUrlï¼Œå³ä½¿è¿™é‡Œä¸ç”¨ï¼Œå…¶ä»–åœ°æ–¹å¯èƒ½ç”¨
                displayArticles(articles, displayArea, titlePrefix || `åˆ†ç±»: ${categoryName}`);
              }
            })
            .catch(error => {
              console.error(`åŠ è½½æ–‡ç« å¤±è´¥ (${categoryName}):`, error);
              displayArea.innerHTML = `<p class="error-message">åŠ è½½æ–‡ç« å¤±è´¥: ${escapeHtml(error.message)}</p>`;
            });
  }

  // --- (navLinks, topLinks, logoLink, search ç›¸å…³äº‹ä»¶ç›‘å¬å™¨ä»£ç ä¿æŒä¸å˜) ---
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const categoryName = link.dataset.categoryName;
      if (!categoryName) return;
      navLinks.forEach(l => l.classList.remove('active'));
      topLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      fetchAndDisplayArticles(categoryName, contentArea, categoryName);
    });
  });

  topLinks.forEach(link => {
    const hrefValue = link.getAttribute('href');
    const categoryName = link.dataset.categoryName;
    link.addEventListener('click', function(e) {
      if (hrefValue && hrefValue !== '#' && hrefValue !== 'javascript:void(0);' &&
              (hrefValue !== 'main.html' || categoryName !== 'é¦–é¡µ') ) {
        if(hrefValue === 'profile.html' || hrefValue === 'publish.html' || hrefValue === 'my_articles.html'){
          return;
        }
      }
      e.preventDefault();
      topLinks.forEach(l => l.classList.remove('active'));
      navLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      if ( (hrefValue === 'main.html' && categoryName === "é¦–é¡µ") || categoryName === "é¦–é¡µ") {
        fetchAndDisplayArticles("ç»¼åˆ", contentArea, "æœ€æ–°æ¨è");
      } else if (staticTopContentMap[categoryName]) {
        contentArea.innerHTML = staticTopContentMap[categoryName];
      } else if (categoryName) {
        fetchAndDisplayArticles(categoryName, contentArea, categoryName);
      } else {
        contentArea.innerHTML = '<p style="text-align:center; padding: 20px; color: #777;">æš‚æ— å†…å®¹ã€‚</p>';
      }
    });
  });

  const logoLink = document.querySelector('a.logo');
  if (logoLink) {
    logoLink.addEventListener('click', (e) => {
      e.preventDefault();
      topLinks.forEach(l => l.classList.remove('active'));
      navLinks.forEach(l => l.classList.remove('active'));
      const homeTopLink = Array.from(topLinks).find(tl => tl.dataset.categoryName === "é¦–é¡µ" );
      if(homeTopLink) homeTopLink.classList.add('active');
      const homeSideLink = Array.from(navLinks).find(sl => sl.dataset.categoryName === "ç»¼åˆ" );
      if(homeSideLink) homeSideLink.classList.add('active');
      fetchAndDisplayArticles("ç»¼åˆ", contentArea, "æœ€æ–°æ¨è");
    });
  }

  const searchInput = document.querySelector('.search-box input[type="text"]');
  const searchButton = document.querySelector('.search-box .search-btn');
  function performSearch() {
    const query = searchInput.value.trim();
    if (!query) {
      fetchAndDisplayArticles("ç»¼åˆ", contentArea, "æœ€æ–°æ¨è");
      return;
    }
    navLinks.forEach(l => l.classList.remove('active'));
    topLinks.forEach(l => l.classList.remove('active'));
    contentArea.innerHTML = '<p style="text-align:center; padding: 20px; color: #777;">æ­£åœ¨æœç´¢ä¸­...</p>';
    fetch(`SearchArticleServlet?query=${encodeURIComponent(query)}`)
            .then(response => {
              if (!response.ok) {
                return response.json().then(errData => {
                  throw new Error((errData && errData.error) ? errData.error : `æœç´¢è¯·æ±‚å¤±è´¥: ${response.status}`);
                }).catch(() => { throw new Error(`æœç´¢è¯·æ±‚å¤±è´¥: ${response.status}`); });
              }
              return response.json();
            })
            .then(articles => {
              if (articles && articles.error) {
                contentArea.innerHTML = `<p class="error-message">æœç´¢é”™è¯¯: ${escapeHtml(articles.error)}</p>`;
              } else {
                displayArticles(articles, contentArea, `æœç´¢ç»“æœ: "${escapeHtml(query)}"`);
              }
            })
            .catch(error => {
              console.error("æœç´¢è¯·æ±‚å¤„ç†å¤±è´¥:", error);
              contentArea.innerHTML = `<p class="error-message">æœç´¢æ—¶å‘ç”Ÿé”™è¯¯: ${escapeHtml(error.message)}</p>`;
            });
  }
  if (searchButton) { searchButton.addEventListener('click', performSearch); }
  if (searchInput) { searchInput.addEventListener('keypress', function(event) { if (event.key === 'Enter') { event.preventDefault(); performSearch(); } }); }


  function loadHotArticlesRanking() {
    const rankListUl = document.getElementById('hot-article-rank-list');
    if (!rankListUl) { return; }
    rankListUl.innerHTML = '<li>æ­£åœ¨åŠ è½½çƒ­é—¨æ–‡ç« ...</li>';
    fetch(`GetRankedArticlesServlet`)
            .then(response => response.ok ? response.json() : response.json().then(err => { throw err; }))
            .then(articles => {
              if (articles && articles.length > 0) {
                let rankHtml = '';
                articles.forEach((article, index) => {
                  const title = article.title || "æ— æ ‡é¢˜";
                  const shortTitle = title.length > 18 ? title.substring(0, 18) + '...' : title;
                  rankHtml += `<li><strong>${index + 1}.</strong> <a href="article.html?id=${article.id}" title="${escapeHtml(title)}">${escapeHtml(shortTitle)}</a><span class="like-count-badge">${article.likesCount !== undefined ? article.likesCount : 0}èµ</span></li>`;
                });
                rankListUl.innerHTML = rankHtml;
              } else { rankListUl.innerHTML = '<li>æš‚æ— çƒ­é—¨æ–‡ç« ã€‚</li>';}
            }).catch(error => {
      console.error("åŠ è½½çƒ­é—¨æ–‡ç« æ¦œå¤±è´¥:", error);
      rankListUl.innerHTML = `<li>åŠ è½½çƒ­é—¨æ–‡ç« æ¦œå¤±è´¥ã€‚</li>`;
    });
  }

  function loadAuthorRanking() {
    const rankListUl = document.getElementById('author-rank-list');
    if (!rankListUl) { return; }
    rankListUl.innerHTML = '<li>æ­£åœ¨åŠ è½½ä½œè€…æ¦œ...</li>';
    fetch(`GetRankedAuthorsServlet`)
            .then(response => response.ok ? response.json() : response.json().then(err => { throw err; }))
            .then(authors => {
              if (authors && authors.length > 0) {
                let rankHtml = '';
                authors.forEach((author, index) => {
                  const authorName = author.authorIdentifier || "åŒ¿åä½œè€…";
                  const shortAuthorName = authorName.length > 12 ? authorName.substring(0, 10) + '...' : authorName;
                  rankHtml += `<li><strong>${index + 1}.</strong> <span class="author-name-rank" title="${escapeHtml(authorName)}">${escapeHtml(shortAuthorName)}</span><span class="like-count-badge">${author.totalLikes !== undefined ? author.totalLikes : 0} æ€»èµ</span></li>`;
                });
                rankListUl.innerHTML = rankHtml;
              } else { rankListUl.innerHTML = '<li>æš‚æ— ä½œè€…æ•°æ®ã€‚</li>'; }
            }).catch(error => {
      console.error("åŠ è½½ä½œè€…æ¦œå¤±è´¥:", error);
      rankListUl.innerHTML = `<li>åŠ è½½ä½œè€…æ¦œå¤±è´¥ã€‚</li>`;
    });
  }

  function handleLogout() {
    localStorage.removeItem('isLoggedIn');
    localStorage.removeItem('userNickname');
    localStorage.removeItem('userAvatarUrl');
    alert("æ‚¨å·²æˆåŠŸç™»å‡ºï¼");
    window.location.href = "login.html";
  }

  document.addEventListener('DOMContentLoaded', () => {
    const userNickname = localStorage.getItem('userNickname');
    const userAvatarUrl = localStorage.getItem('userAvatarUrl');
    const navUserNickname = document.getElementById('navUserNickname');
    const navProfileLink = document.getElementById('navProfileLink');
    const navUserAvatar = document.getElementById('navUserAvatar');
    const logoutButton = document.getElementById('logoutButton');

    if (userNickname && navUserNickname) {
      navUserNickname.textContent = `æ¬¢è¿ï¼Œ${escapeHtml(userNickname)}ï¼`;
      navUserNickname.href = "profile.html"; // ç™»å½•åå¯ä»¥ç‚¹å‡»è·³è½¬åˆ°ä¸ªäººèµ„æ–™é¡µ
      if (navProfileLink) navProfileLink.style.display = 'inline-block';
      if (logoutButton) logoutButton.style.display = 'inline-block';

      if (navUserAvatar) {
        // **ã€ä¿®æ”¹éƒ¨åˆ†ã€‘**
        // ç›´æ¥ä½¿ç”¨ localStorage ä¸­çš„ç›¸å¯¹è·¯å¾„
        // æµè§ˆå™¨ä¼šè‡ªåŠ¨è§£æç›¸å¯¹äºå½“å‰é¡µé¢çš„è·¯å¾„
        if (userAvatarUrl && userAvatarUrl !== 'default-avatar.png') {
          navUserAvatar.src = userAvatarUrl;
        } else {
          navUserAvatar.src = 'default-avatar.png';
        }
        navUserAvatar.style.display = 'inline-block';
      }
    } else if (navUserNickname) {
      navUserNickname.innerHTML = '<a href="login.html" style="text-decoration:none; color:#007aff;">ç™»å½•/æ³¨å†Œ</a>';
      if (navProfileLink) navProfileLink.style.display = 'none';
      if (navUserAvatar) navUserAvatar.style.display = 'none';
      if (logoutButton) logoutButton.style.display = 'none';
    }

    if(logoutButton){
      logoutButton.addEventListener('click', handleLogout);
    }

    // --- é¡µé¢åŠ è½½é€»è¾‘ä¿æŒä¸å˜ ---
    if (window.location.pathname.includes('main.html')) {
      const activeTopLink = document.querySelector('.nav-menu a.active');
      const activeSideLink = document.querySelector('.category-nav a.active');
      if (activeTopLink && activeTopLink.dataset.categoryName === "é¦–é¡µ") {
        fetchAndDisplayArticles("ç»¼åˆ", contentArea, "æœ€æ–°æ¨è");
      } else if (activeSideLink && activeSideLink.dataset.categoryName) {
        fetchAndDisplayArticles(activeSideLink.dataset.categoryName, contentArea, activeSideLink.dataset.categoryName);
      } else {
        fetchAndDisplayArticles("ç»¼åˆ", contentArea, "æœ€æ–°æ¨è");
      }
      loadHotArticlesRanking();
      loadAuthorRanking();
    }
  });
</script>
</body>
</html>